name: Build Volla Launcher (debug)

on:
  workflow_dispatch:

jobs:
  debug-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Debug Build Apk inside Qt Docker
        env:
          ANDROID_KEYSTORE_FILE_CONTENTS: ${{ secrets.ANDROID_KEYSTORE_FILE_CONTENTS }}
          ANDROID_KEYSTORE_PASS: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
        run: |
          set -xeuo pipefail
          export CACHE_DIR=build/cache
          export M2_HOME="$(realpath -m $CACHE_DIR/.m2)"
          export MAVEN_HOME="$M2_HOME"
          export GRADLE_USER_HOME="$(realpath -m $CACHE_DIR/.gradle)"
          export VERSION="$(git describe --tags || git rev-parse --short HEAD)"
          export TIMESTAMP="$(date +%Y%m%d%H%M)"
          export BUILD_ID="$VERSION-$TIMESTAMP"
          # asegurar carpetas y permisos en el runner
          sudo mkdir -p "$MAVEN_HOME" "$GRADLE_USER_HOME" build releases
          sudo chmod -R a+rwX build releases "$MAVEN_HOME" "$GRADLE_USER_HOME" || true

          # montamos y arrancamos el contenedor con diagnÃ³stico
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -e ANDROID_KEYSTORE_FILE_CONTENTS \
            -e ANDROID_KEYSTORE_PASS \
            -e ANDROID_KEYSTORE_ALIAS \
            -e CACHE_DIR \
            -e M2_HOME \
            -e MAVEN_HOME \
            -e GRADLE_USER_HOME \
            -e VERSION \
            -e BUILD_ID \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            a12e/docker-qt:5.13-android_arm64_v8a \
            bash -lc "\
              set -xeuo pipefail; \
              echo '--- CONTAINER: id / user / groups ---'; id; \
              echo '--- CONTAINER: df -h / ls -la /work (size & perms) ---'; df -h / || true; ls -la /work || true; \
              echo '--- CONTAINER: checking Qt & NDK ---'; ls -la /opt/qt || true; /opt/qt/5.13.2/android_arm64_v8a/bin/qmake -v || true; \
              echo '--- CONTAINER: check ndk ---'; ls -la /opt/android-sdk || true; /opt/android-sdk/ndk-r19c/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++ --version || true; \
              echo '--- ENV ---'; env | sort; \
              echo '--- LIST PROJECT (top) ---'; ls -la /work || true; \
              echo '--- show vendor/qml if exist (short) ---'; ls -la vendor || true; ls -la qml || true; \
              echo '--- RUN BUILD (verbose) ---'; \
              mkdir -p build/android_arm64_v8a || true; \
              set -x; ./build_package_android ./releases 2>&1 | tee /work/build_debug_log.txt || true; \
              echo '--- END BUILD: ls releases and cat log ---'; ls -la ./releases || true; tail -n +1 /work/build_debug_log.txt || true;"

          # aseguramos que runner puede leer los artefactos
          sudo chown -R "$(id -u):$(id -g)" ./releases || true
          ls -la ./releases || true
